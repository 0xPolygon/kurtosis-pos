name: deploy

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: 0 6 * * * # Run this workflow every day at 6 AM Paris time (UTC).
  workflow_dispatch:

# Permissions required to pull images from GAR
permissions:
  contents: read
  actions: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

env:
  ENCLAVE_NAME: pos
  DEVTOOLS_SLACK_ALERTS_CHANNEL_ID: C04DS0SG599

jobs:
  run-without-args:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_token: ${{ secrets.DOCKER_TOKEN }}

      - name: Deploy devnet
        run: |
          set -o pipefail
          kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed . 2>&1 | tee run.log

      - uses: ./.github/actions/monitor

      - uses: ./.github/actions/test-state-sync

      - uses: ./.github/actions/cleanup
        if: always()

  list-ymls:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
      - id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Nightly mode: include all configs except cl-el-genesis and external-l1
            file_paths=$(ls -R ./.github/configs/{*,*/*,*/*/*}.yml | grep -Ev "cl-el-genesis|external-l1")
          else
            # Regular mode: exclude nightly configs
            file_paths=$(ls -R ./.github/configs/{*,*/*}.yml | grep -Ev "nightly")
          fi
          echo "file_paths=${file_paths}"

          matrix=$(echo "${file_paths}" | while read -r file_path; do
            file_name=$(basename -s ".yml" "${file_path}")
            folder_name=$(basename $(dirname "${file_path}"))
            if [[ "${folder_name}" == "configs" || "${folder_name}" == "nightly" ]]; then
              job_name="${file_name}"
            else
              job_name="${folder_name}-${file_name}"
            fi
            echo "{\"name\": \"$job_name\", \"path\": \"$file_path\"}"
          done | jq -s -c '.')
          echo "matrix=${matrix}"

          echo "matrix=${matrix}" >> $GITHUB_OUTPUT

  run-with-args:
    needs: [list-ymls]
    name: run-with-${{ matrix.file.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.list-ymls.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_token: ${{ secrets.DOCKER_TOKEN }}

      - name: Deploy devnet
        run: |
          set -o pipefail
          kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed --args-file=${{ matrix.file.path }} . 2>&1 | tee run.log

      - uses: ./.github/actions/monitor
        if: ${{ !contains(matrix.file.name, 'additional-services') }}
        with:
          skip_checkpoints: ${{ contains(matrix.file.name, 'heimdall-v2-erigon') }} # TODO: Understand why checkpoints are not being created in this case.

      - uses: ./.github/actions/test-state-sync
        if: ${{ !contains(matrix.file.name, 'additional-services') }}
        with:
          l1_rpc: ${{ contains(matrix.file.name, 'anvil') && 'anvil' || 'el-1-geth-lighthouse' }}

      - uses: ./.github/actions/cleanup
        if: always()
        with:
          args_filename: ${{ matrix.file.name }}
          # Cache is only saved by main branch runs to avoid excessive storage use
          save_cache: ${{ github.ref == 'refs/heads/main' && matrix.file.name == 'heimdall-v2-mix' }}

  run-with-external-l1:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_token: ${{ secrets.DOCKER_TOKEN }}

      - name: Deploy L1 devnet
        run: kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed --args-file ./.github/configs/nightly/external-l1/ethereum.yml --verbosity=DETAILED github.com/ethpandaops/ethereum-package@e0c96ff24829d91ced75b9ce0594e589e4b463e4 # 2026-02-17

      - name: Wait for L1 to be ready
        run: |
          cl_rpc_url=$(kurtosis port print ${{ env.ENCLAVE_NAME }} cl-1-lighthouse-geth http)
          while true; do
            slot=$(curl $cl_rpc_url/eth/v1/beacon/headers/ | jq --raw-output ".data[0].header.message.slot")
            echo "L1 chain is starting up... Current slot: $slot"
            if [[ "$slot" =~ ^[0-9]+$ ]] && [[ "$slot" -gt "0" ]]; then
              echo "L1 chain has started!"
              break
            fi
            sleep 5
          done

      - name: Deploy L2 devnet
        run: kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed --args-file=./.github/configs/nightly/external-l1/polygon-pos-with-external-l1.yml .

      - uses: ./.github/actions/monitor
        with:
          skip_checkpoints: 'true'  # TODO: Understand why checkpoints are not being created in this case.

      - uses: ./.github/actions/test-state-sync

      - uses: ./.github/actions/cleanup
        if: always()
        with:
          args_filename: external-l1

  run-with-cl-el-genesis:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_token: ${{ secrets.DOCKER_TOKEN }}

      - name: Deploy devnet for the first time
        run: kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed .

      - name: Inspect enclave
        run: kurtosis enclave inspect ${{ env.ENCLAVE_NAME }}

      - name: Monitor block progress
        working-directory: .github/actions/monitor
        run: ./blocks.sh ${{ env.ENCLAVE_NAME }}

      - name: Retrieve L2 CL genesis file
        working-directory: .github/configs/nightly/cl-el-genesis
        run: |
          kurtosis files inspect ${{ env.ENCLAVE_NAME }} l2-cl-genesis genesis.json | jq > l2-cl-genesis.json
          jq . l2-cl-genesis.json

      - name: Retrieve L2 EL genesis file
        working-directory: .github/configs/nightly/cl-el-genesis
        run: |
          kurtosis files inspect ${{ env.ENCLAVE_NAME }} l2-el-genesis genesis.json | jq > l2-el-genesis.json
          jq . l2-el-genesis.json

      - name: Retrieve MATIC contract addresses
        working-directory: .github/configs/nightly/cl-el-genesis
        run: |
          kurtosis files inspect ${{ env.ENCLAVE_NAME }} matic-contract-addresses contractAddresses.json | jq > matic-contract-addresses.json
          jq . matic-contract-addresses.json

      - name: Stop L2 participants
        run: |
          kurtosis service stop ${{ env.ENCLAVE_NAME }} l2-cl-1-heimdall-v2-bor-validator
          kurtosis service stop ${{ env.ENCLAVE_NAME }} l2-cl-1-rabbitmq
          kurtosis service stop ${{ env.ENCLAVE_NAME }} l2-el-1-bor-heimdall-v2-validator

      - name: Deploy devnet for the second time
        run: kurtosis run --enclave=${{ env.ENCLAVE_NAME }} --verbosity detailed --args-file=./.github/configs/nightly/cl-el-genesis/polygon-pos-with-cl-el-genesis.yml .

      - uses: ./.github/actions/monitor

      - uses: ./.github/actions/test-state-sync

      - uses: ./.github/actions/cleanup
        if: always()
        with:
          args_filename: cl-el-genesis

  workflow-summary:
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    needs:
      - run-without-args
      - run-with-args
      - run-with-external-l1
      - run-with-cl-el-genesis
    steps:
      - uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          method: chat.postMessage
          payload: |
            {
              "channel": ${{ env.DEVTOOLS_SLACK_ALERTS_CHANNEL_ID }},
              "text": "Kurtosis POS Nightly - Test Summary",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Kurtosis POS Nightly>: ${{ contains(needs.*.result, 'failure') && 'some tests failed ❌' || (contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'skipped')) && 'some tests were skipped ⚠️' || 'all tests passed ✅' }}",
                  }
                }
              ]
            }
