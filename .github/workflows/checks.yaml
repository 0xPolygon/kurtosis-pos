name: checks

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      KURTOSIS_VERSION: 1.15.2

    steps:
      - uses: actions/checkout@v6

      - name: Install kurtosis
        run: |
          echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
          sudo apt update
          sudo apt install -y kurtosis-cli=${{ env.KURTOSIS_VERSION }}
          kurtosis analytics disable

      - name: Run kurtosis linter
        run: kurtosis lint .
      
      - name: Run markdown linter
        uses: rvben/rumdl@079e7a4b1315ae2d6070c0816c688ff526689815 # v0.1.15

  typos:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
      - uses: crate-ci/typos@78bc6fb2c0d734235d57a2d6b9de923cc325ebdd # v1.43.4

  unit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      KURTOSIS_TEST_VERSION: v0.0.6
      GO_VERSION: 1.23 # required by kurtosis-test v0.0.6

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install kurtosis-test
        run: |
          git clone --branch ${{ env.KURTOSIS_TEST_VERSION }} https://github.com/ethereum-optimism/kurtosis-test.git /tmp/kurtosis-test
          cd /tmp/kurtosis-test
          go build -o kurtosis-test cli/main.go
          sudo cp kurtosis-test /usr/local/bin

      - name: Run unit tests
        run: kurtosis-test .
