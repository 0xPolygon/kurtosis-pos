name: publish-docker-images

# Manually triggered workflow to build and publish docker images to GHCR.
# Update the respective env vars below to deploy new versions:
# - pos-contract-deployer: POS_CONTRACTS_BRANCH, POS_CONTRACTS_COMMIT_SHA
# - pos-el-genesis-builder: GENESIS_CONTRACTS_BRANCH, GENESIS_CONTRACTS_COMMIT_SHA
# - pos-validator-config-generator: HEIMDALL_V2_VERSION, POLYGON_CLI_VERSION
on:
  workflow_dispatch:
    inputs:
      image:
        description: Which image(s) to build and publish
        required: true
        type: choice
        default: all
        options:
          - all
          - pos-contract-deployer
          - pos-el-genesis-builder
          - pos-validator-config-generator

# Prevent concurrent workflow runs
concurrency:
  group: publish-docker-images
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io

  # pos-contract-deployer settings
  POS_CONTRACTS_IMAGE_NAME: 0xPolygon/pos-contract-deployer
  POS_CONTRACTS_BRANCH: anvil-pos
  POS_CONTRACTS_COMMIT_SHA: d96d592 # 2025/08/01

  # pos-el-genesis-builder settings
  EL_GENESIS_BUILDER_IMAGE_NAME: 0xPolygon/pos-el-genesis-builder
  GENESIS_CONTRACTS_BRANCH: master
  GENESIS_CONTRACTS_COMMIT_SHA: 96a19dd # 2025/01/08

  # pos-validator-config-generator settings
  VALIDATOR_CONFIG_IMAGE_NAME: 0xPolygon/pos-validator-config-generator
  HEIMDALL_V2_VERSION: 0.6.0
  POLYGON_CLI_VERSION: v0.1.102

jobs:
  publish-pos-contract-deployer:
    if: inputs.image == 'all' || inputs.image == 'pos-contract-deployer'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Tag images with the specific pos-contracts commit SHA for version control.
      # This ensures reproducible builds tied to a specific contracts version.
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.POS_CONTRACTS_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.POS_CONTRACTS_COMMIT_SHA }}

      - name: Build and push docker image
        id: push
        uses: docker/build-push-action@v6
        with:
          context: docker
          file: docker/pos-contract-deployer.Dockerfile
          build-args: |
            POS_CONTRACTS_BRANCH=${{ env.POS_CONTRACTS_BRANCH }}
            POS_CONTRACTS_TAG_OR_COMMIT_SHA=${{ env.POS_CONTRACTS_COMMIT_SHA }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.POS_CONTRACTS_IMAGE_NAME}}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  publish-pos-el-genesis-builder:
    if: inputs.image == 'all' || inputs.image == 'pos-el-genesis-builder'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Tag images with the specific genesis-contracts commit SHA for version control.
      # This ensures reproducible builds tied to a specific contracts version.
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.EL_GENESIS_BUILDER_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.GENESIS_CONTRACTS_COMMIT_SHA }}

      - name: Build and push docker image
        id: push
        uses: docker/build-push-action@v6
        with:
          context: docker
          file: docker/pos-el-genesis-builder.Dockerfile
          build-args: |
            GENESIS_CONTRACTS_BRANCH=${{ env.GENESIS_CONTRACTS_BRANCH }}
            GENESIS_CONTRACTS_TAG_OR_COMMIT_SHA=${{ env.GENESIS_CONTRACTS_COMMIT_SHA }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.EL_GENESIS_BUILDER_IMAGE_NAME}}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  publish-pos-validator-config-generator:
    if: inputs.image == 'all' || inputs.image == 'pos-validator-config-generator'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Tag images with the Heimdall v2 version for version control.
      # This ensures reproducible builds tied to a specific Heimdall version.
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.VALIDATOR_CONFIG_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.HEIMDALL_V2_VERSION }}

      - name: Build and push docker image
        id: push
        uses: docker/build-push-action@v6
        with:
          context: docker
          file: docker/pos-validator-config-generator.Dockerfile
          build-args: |
            HEIMDALL_V2_VERSION=${{ env.HEIMDALL_V2_VERSION }}
            POLYGON_CLI_VERSION=${{ env.POLYGON_CLI_VERSION }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.VALIDATOR_CONFIG_IMAGE_NAME}}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true
